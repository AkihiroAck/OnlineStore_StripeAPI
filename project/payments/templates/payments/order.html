<!DOCTYPE html>
<html>
<head>
    <title>Мой заказ</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .debug-console {
            /* Стили как в item.html */
        }
    </style>
</head>
<body>
    <h1>Мой заказ</h1>
    
    {% if order and order.items.count > 0 %}
        <ul>
            {% for item in order.items.all %}
                <li>
                    {{ item.name }} - ${{ item.price }}
                    <a href="{% url 'remove_from_order' item.id %}">[−]</a>
                </li>
            {% endfor %}
        </ul>
        
        <p>
            {% if order.tax %}
                Налог: {{ order.tax.percentage }}%<br>
            {% endif %}
            {% if order.discount %}
                Скидка: {{ order.discount.percent_off }}%<br>
            {% endif %}
            <b>Итого: ${{ order.get_total_price }}</b>
        </p>
        <button id="checkout-button">Оформить заказ</button>
        <a href="{% url 'clear_order' %}">Очистить заказ</a>
        
        <script>
            const stripe = Stripe('{{ stripe_public_key }}');
            document.getElementById('checkout-button').addEventListener('click', function() {
                fetch('{% url "buy_order" order.id %}')
                    .then(response => response.json())
                    .then(session => stripe.redirectToCheckout({ sessionId: session.session_id }))
                    .catch(error => console.error('Error:', error));
            });
        </script>
    {% else %}
        <p>Ваш заказ пуст</p>
    {% endif %}
    
    <a href="/">Продолжить покупки</a>
    
    <div class="debug-console" id="debug-console">
        {% for message in messages %}
            {% if message.level == DEFAULT_MESSAGE_LEVELS.DEBUG %}
                <div class="debug-message">{{ message }}</div>
            {% endif %}
        {% endfor %}
    </div>
    
    <script>
        // Автопрокрутка консоли
        document.getElementById('debug-console').scrollTop = 
            document.getElementById('debug-console').scrollHeight;
    </script>
</body>
</html>